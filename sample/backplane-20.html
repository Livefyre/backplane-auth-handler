<!DOCTYPE html>
<!--
Livefyre setup:

set Domain object json_config['janrain_capture'] =
{
   "schema_mapping":{
      "bio":"aboutMe",
      "display_name":"displayName",
      "id":"uuid",
      "connections":"profiles",
      "image_url":"photos",
      "location":"currentLocation",
      "email":"email"
   },
   "base_url":"https://livefyre.dev.janraincapture.com/",
   "user_type":"user",
   "enable_push_updates":True,
   "client_id":"6xp58xr87t6twcddsjwjvz3t9pzhvcwa",
   "backplane":{
      "scope":"bus:livefyre-dev",
      "version":"2.0"
   },
   "client_secret":"datffkkt8h4q8d2vbgj9xpq6nzdn2m5h"
}

-->
<html>
    <head>
        <meta charset="UTF-8">
        <title>Backplane 1.2 w/ Janrain Capture Demo</title>
        <script src="assets/capture.js"></script>
        <style type="text/css">
            #login {
                color: blue;
            }
        </style>
    </head>

    <body>

        <h1>LFEP Auth Sample</h1>

        <script src="http://d134l0cdryxgwa.cloudfront.net/backplane2.js" ></script>
        <script src="https://livefyre.dev.janraincapture.com/cdn/javascripts/capture_client.js"></script>

        <link rel="stylesheet" href="assets/capture-style.css">
        <script>
          (function() {
              if (typeof window.CAPTURE !== 'object') window.CAPTURE = {};

              window.CAPTURE.config = {
                  // configuration arguments
                  bp_channel: function() {
                    return Backplane.getChannelID();
                  },
                  capture_ui_server_url: 'https://livefyre.dev.janraincapture.com',
                  capture_server_url: 'https://livefyre.dev.janraincapture.com', // e.g. https://demo.eval.janraincapture.com/
                  redirect_uri: 'http://localhost:8090/sample/oauth-redirect.html',
                  response_type: 'token',
                  client_id: '6xp58xr87t6twcddsjwjvz3t9pzhvcwa',
                  application_id: 'livefyre-dev',
                  xd_receiver: 'http://localhost:8090/sample/xdcomm.html',
                  age_limit_url: 'http://localhost:8090/sample/unable-to-login.html',
                  // page event callbacks
                  callbacks: {
                      userSignedIn: function () {
                          var signin = document.getElementById('signin_link')
                          if (signin){ signin.className = 'hidden'; }
                          var loggedInNav = document.getElementById('logged_in_nav');
                          loggedInNav.className = '';
                          var messageDiv = document.getElementById('message');
                          if (messageDiv){
                              var message = CAPTURE.util.getCookie('staticMessage');
                              if (message) {
                                  CAPTURE.util.delCookie('staticMessage');
                              } else {
                                  message = 'Welcome, thanks for coming<br><a href="profile_image.html">link to profile image sample</a>';
                              }
                              messageDiv.innerHTML = message;
                              messageDiv.style.display = 'block';
                          }
                      },
                      recoverPasswordComplete: function () {
                          // Show password recovery page here
                          var passwordFrame = CAPTURE.profilePasswordResetFrame(),
                          pageContent = document.getElementById('page_content');
                          savedPage = pageContent.innerHTML;
                          while (pageContent.firstChild) {
                              pageContent.removeChild(pageContent.firstChild);
                          }
                          pageContent.appendChild(passwordFrame);
                      },
                      recoverPasswordStart: function () {
                          CAPTURE.closeModal()
                          var messageDiv = document.getElementById('message');
                          if (messageDiv){
                              messageDiv.innerHTML = 'Please check your email.';
                              messageDiv.style.setProperty('display', 'block');
                          }
                      },
                      emailVerified: function () {
                          var messageDiv = document.getElementById('message');
                          if (messageDiv){
                              messageDiv.innerHTML = 'Your email has been verified';
                              messageDiv.style.setProperty('display', 'block');
                          }

                      },
                    userUpdatedData: function () {
                       CAPTURE.util.setCookie('staticMessage', 'Profile Saved!');
                       var livefyreUserDomain = window.AI.lfDomain;
                       var jrTokenMatch = document.cookie.match(/janrainToken=([^;]+)/),
                           jrToken, lfPushUrl;
                       if (jrTokenMatch && (jrTokenMatch.length == 2)) {
                           jrToken = jrTokenMatch[1]
                       }
                       if (jrToken) {function empty_callback() {};
                           var headID = document.getElementsByTagName("head")[0];
                           var newScript = document.createElement('script');
                           newScript.type = 'text/javascript';
                           newScript.src = 'http://' + this.options.config.livefyre_server_url + '/api/v1.1/private/capture/profile_updated/?jrtoken=' + encodeURI(jrToken) + '&callback=empty_callback';
                           headID.appendChild(newScript);
                       }
                       alert('profile saved');
                       document.getElementById('ssoProfileWrapper').empty().adopt(CAPTURE.profileFrame());
                    },
                      sessionExpired: function() {
                          window.CAPTURE.invalidateSession();
                          window.location.refresh();
                      },
                      captureInitalized: function(CAPTURE) {
                          queryDict = CAPTURE.util.queryDict(
                              window.location.search.substring(1));
                          if (queryDict.email_verified == 'true') {
                              CAPTURE.emailVerified();
                          }
                      }
                  }
              };
          })();

        Backplane(CAPTURE.init);
        Backplane.init({
            serverBaseURL: 'https://backplane1.janrainbackplane.com/v2',
            busName: 'livefyre-dev'
        });

        </script>

        <div id="navigation">
          <a id="signin_link" href="">Register / Sign In</a>

          <!-- ATTACH SIGNIN LAUNCHER -->
          <script>
            document.getElementById('signin_link').onclick = function (event) {
                CAPTURE.startModalLogin();
                Backplane.expectMessages('identity/login');
                return false;
            };
          </script>

        <div id="logged_in_nav" class="hidden">
            <a id="public_profile_link" href="./public_profile.html">View your profile</a> |
            <a id="profile_link" href="./profile.html">Edit your profile</a> |
            <a id="logout_link" href="">Logout</a>
        </div>

          <!-- ATTACH PROFILE LAUNCHER -->
          <script>
            document.getElementById('logout_link').onclick = function (event) {
                Backplane.resetCookieChannel();
                CAPTURE.invalidateSession();
                CAPTURE.util.delCookie('backplane-channel');
                window.auth.logout();
                return false;
            };
          </script>
          <br/>
        </div>

        <a href="#" id="login"></a>
        <div id="log"></div>

        <script src="../../bower_components/cajon/cajon.js"></script>
        <script src="../../requirejs.conf.js"></script>
        <script>
            require.config({
                baseUrl: '../..',
                packages: [{
                    name: 'auth',
                    location: 'bower_components/auth/src'
                }]
            });
            require([
                'livefyre-auth',
                'backplane-auth-handler',
                'auth/contrib/auth-button',
                'auth/contrib/auth-log'
            ], function(auth, bpHandler, AuthButton, AuthLog) {

                window.auth = auth;
                bpHandler(auth, 'http://www.fy.re', 'NjkzOTg4LjQzNzUzMTUxNg==', '286470');

                // make a delegate
                var authDelegate = {};

                /**
                 * Login function
                 * In this case, opens a login modal and triggers Backplane to start listening
                 * for login messages
                 */
                authDelegate.login = function(callback) {
                    CAPTURE.startModalLogin();
                    window.Backplane.expectMessages('identity/login');
                    callback();
                };

                /**
                 * Logout function
                 * In this case, invalidates the session and removes the cookie.
                 * Also reloads the page to change state. In order to do this without a reload,
                 * it would be necessary to also update the UI.
                 */
                authDelegate.logout = function(callback) {
                    CAPTURE.invalidateSession();
                    CAPTURE.util.delCookie('backplane-channel');
                    callback();
                };

                /**
                 * View profile function
                 * Arguments are delegate parameter and an author parameter
                 * Used any time a view profile event is triggered
                 */
                authDelegate.viewProfile = function(delegate, author) {
                    console.log(author);
                };

                /**
                 * Edit profile function
                 * Arguments are delegate parameter and an author parameter
                 * Used any time an edit profile event is triggered
                 */
                authDelegate.editProfile = function(delegate, author) {
                    console.log(author);
                };

                auth.delegate(authDelegate);

                window.Auth = auth;
                window.AuthButton = new AuthButton(auth, document.getElementById('login'));
                window.AuthLog = new AuthLog(auth, document.getElementById('log'));
          });
        </script>
    </body>
</html>

